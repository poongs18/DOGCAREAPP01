// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

//////////////////////////////////////////////////////
// ENUMS
//////////////////////////////////////////////////////
enum Role {
  CUSTOMER
  ADMIN
  DOCTOR
  RECEPTIONIST
}

enum AccountStatus {
  ACTIVE
  SUSPENDED
  DELETED
}

enum PetStatus {
  ACTIVE
  INACTIVE
}

enum PetGender {
  MALE
  FEMALE
  UNKNOWN
}

enum BookingStatus {
  BOOKED
  CANCELLED
  COMPLETED
}

enum ServiceType {
  OPERATIONAL // Grooming, Swimming, Training
  MEDICAL // Vaccination, Consultation
}

enum ServiceStatus {
  ACTIVE
  INACTIVE
}

enum TransportOption {
  NONE
  PICKUP
  DROP
  BOTH
}

//////////////////////////////////////////////////////
// USER
//////////////////////////////////////////////////////
model User {
  id           String        @id @default(cuid())
  email        String        @unique
  phone        String?       @unique
  name         String
  passwordHash String
  role         Role          @default(CUSTOMER)
  status       AccountStatus @default(ACTIVE)

  addresses           Address[]
  refreshTokens       RefreshToken[]
  passwordResetTokens PasswordResetToken[]
  pets                Pet[]

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  Booking   Booking[]

  @@index([role])
  @@index([status])
  @@map("users")
}

model RefreshToken {
  id        String   @id @default(cuid())
  userId    String
  token     String   @unique
  expiresAt DateTime
  revoked   Boolean  @default(false)

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@index([userId])
  @@map("refresh_tokens")
}

model PasswordResetToken {
  id        String   @id @default(cuid())
  userId    String
  token     String   @unique
  expiresAt DateTime
  used      Boolean  @default(false)

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@index([userId])
  @@map("password_reset_tokens")
}

//////////////////////////////////////////////////////
// ADDRESS
//////////////////////////////////////////////////////
model Address {
  id     String @id @default(cuid())
  userId String

  label       String
  addressLine String
  city        String
  state       String
  postalCode  String
  country     String  @default("India")
  isDefault   Boolean @default(false)

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // ✅ Composite Unique Constraint (IMPORTANT)
  @@unique([userId, addressLine, city, postalCode])
  @@index([userId])
  @@map("addresses")
}

//////////////////////////////////////////////////////
// PET
//////////////////////////////////////////////////////
model Pet {
  id String @id @default(cuid())

  // Basic details
  name     String
  breed    String?
  gender   PetGender?
  age      Float?
  weightKg Float?
  notes    String?

  // Ownership
  ownerId String
  owner   User   @relation(fields: [ownerId], references: [id], onDelete: Cascade)

  // Status
  status PetStatus @default(ACTIVE)

  // Timestamps
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  Booking   Booking[]

  @@index([ownerId])
  @@map("pets")
}

//////////////////////////////////////////////////////
// SERVICES
//////////////////////////////////////////////////////
model Service {
  id        String @id @default(cuid())
  name      String @unique   // Grooming, Training, etc
  type      ServiceType
  status    ServiceStatus @default(ACTIVE)

  variants  ServiceVariant[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

//////////////////////////////////////////////////////
// SERVICE VARIANT
//////////////////////////////////////////////////////
model ServiceVariant {
  id          String @id @default(cuid())
  serviceId   String

  name        String @unique // Custom Grooming, Paw-dicure, etc
  description String?
  price       Float
  durationMin Int?          // optional, informational
  isActive    Boolean @default(true)

  service     Service  @relation(fields: [serviceId], references: [id])
  bookings    Booking[]

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([serviceId])
}

//////////////////////////////////////////////////////
// BOOKING
//////////////////////////////////////////////////////
model Booking {
  id        String @id @default(cuid())

  userId    String
  petId     String

  serviceVariantId String

  bookingDate DateTime
  bookingTime DateTime

  transportOption TransportOption @default(NONE)

  totalAmount Float
  notes       String?

  status BookingStatus @default(BOOKED)

  user    User           @relation(fields: [userId], references: [id])
  pet     Pet            @relation(fields: [petId], references: [id])
  variant ServiceVariant @relation(fields: [serviceVariantId], references: [id])

  // ✅ ADD THESE 3 LINES
  groomingDetails GroomingBookingDetails?
  trainingDetails TrainingBookingDetails?
  vetDetails      VetBookingDetails?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([petId])
  @@index([serviceVariantId])
}

//////////////////////////////////////////////////////
// GROOMING
//////////////////////////////////////////////////////
model GroomingBookingDetails {
  id        String @id @default(cuid())
  bookingId String @unique

  groomingStyle   String?
  coatCondition   String?
  specialRequests String?

  booking Booking @relation(fields: [bookingId], references: [id])
}
//////////////////////////////////////////////////////
// TRAINING
//////////////////////////////////////////////////////
model TrainingBookingDetails {
  id        String @id @default(cuid())
  bookingId String @unique

  trainingLevel String?
  behaviorNotes String?
  goals         String?

  booking Booking @relation(fields: [bookingId], references: [id])
}
//////////////////////////////////////////////////////
// VET DETAILS
//////////////////////////////////////////////////////
model VetBookingDetails {
  id        String @id @default(cuid())
  bookingId String @unique

  symptoms        String?
  previousIssues  String?
  medications     String?

  booking Booking @relation(fields: [bookingId], references: [id])
}
